{"formatVersion":"1.0","tagData":{"name":"Send Iot Hub","icon":"data:image/png;base64,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","description":"","functions":[{"id":"function_0","name":"New Function","connector":{"inputs":[{"label":""}],"outputs":[]},"properties":[{"name":"AzureIoTHubName","referenceName":"_iotHubName","type":"string","defaultValue":"IoTHubName"},{"name":"Api Version","referenceName":"_apiVersion","type":"string","defaultValue":"api-version=2016-02-03"},{"name":"DeviceID","referenceName":"_deviceId","type":"string","defaultValue":"MESH"},{"name":"SAS","referenceName":"_sas","type":"string","defaultValue":"SAS"}],"extension":{"initialize":"","receive":"","execute":"if(typeof MorningGirl === \"undefined\"){\n    var MorningGirl = {};\n}\n\n// Azure IoTに温度情報を送信するクラス\n// コンストラクタ\nMorningGirl.AzureIot = function(){\n        // MessageValueとプロパティの中身を検証\n        this.CheckObjectValues(messageValues);\n        this.CheckObjectValues(properties);\n\n　　　　 // IoT Hub Name\n        this._iotHubName = this.GetPropertyValue(properties, \"_iotHubName\");\n        // IoT Hub Rest API の Version\n        // 2017/05/01 時点では「api-version=2016-02-03」が最新\n        this._apiVersion = this.GetPropertyValue(properties, \"_apiVersion\");\n\n        // IoT Hub に登録しているDevice ID\n        this._deviceId = this.GetPropertyValue(properties, \"_deviceId\");\n\n        // IoT Hub に接続する際に使用するSAS(Shared Access Signatures)\n        this._sas = this.GetPropertyValue(properties, \"_sas\");\n\n        // MESHから受け渡される温度情報 Message Valueから取得\n        this._temperature = this.GetMessageValue(messageValues, \"temperature\");\n\n        // リクエスト用URL\n        this._requestUrl = \"https://\" + this._iotHubName + \".azure-devices.net/devices/\" + this._deviceId + \"/messages/events?\" + this._apiVersion;\n\n        log(\"コンストラクタ完了 : \" + this._requestUrl);\n}\n\nMorningGirl.AzureIot.prototype = {\n    // IoT Hubにメッセージを送信\n    SendIotHub : function(){\n            // IoT Hubに送信するオブジェクトを作成\n            var sendData = { \n                \"DeviceId\": this._deviceId, \n                \"Temperature\": this._temperature \n            };\n\n            var requestHeaders = {\n                'X-HTTP-Method-Override': 'POST',\n                \"Authorization\" : this._sas,\n                \"Content-Type\" : \"application/json\"\n            };\n\n            // MESH SDK の中で利用できるajaxオブジェクトでPOSTを実施\n            ajax(this._requestUrl,\n                {\n                    type: 'POST',\n                    timeout : 5000,\n                    headers : requestHeaders,\n                    data : sendData,\n                    success : this.successFunc,\n                    error : this.errorFunc,\n                    crossDomain: true,\n                }\n            );\n\n    },\n    // MessageValues から 任意のオブジェクトを取得\n    // MessageValues には、各MESHのInputデータが渡ってくる。\n    // 温度であれば\"temperature\"\n    // https://meshprj.com/sdk/doc/ja/ にいまいち説明が足りない\n    GetMessageValue : function(messageValues, targetObject){\n        if(MorningGirl.Util.is(messageValues,\"Object\"))\n            throw \"Message Valuesの型がオブジェクトではありません。\";\n\n        if(MorningGirl.Util.is(targetObject,MorningGirl.Util.TypeName.String))\n            throw \"targetObjectの型が文字列ではありません。文字列を指定してください。\";\n\n        if(!(targetObject in messageValues))\n            throw \"messageValues に \" + targetObject + \" が定義されていません。\";\n\n        return messageValues[targetObject];\n    },\n\n    // MESH SDKで指定されたpropertiesを取得\n    // 基本的にはMessageObjectの取得と変わらないけど、今後の変化を考慮して定義\n    GetPropertyValue : function(properties, targetObject){\n        if(MorningGirl.Util.is(properties,\"Object\"))\n            throw \"propertiesの型がオブジェクトではありません。\";\n\n        if(MorningGirl.Util.is(targetObject,MorningGirl.Util.TypeName.String))\n            throw \"targetObjectの型が文字列ではありません。文字列を指定してください。\";\n\n        if(!(targetObject in properties))\n            throw \"properties に \" + targetObject + \" が定義されていません。\";\n\n        return properties[targetObject];\n    },\n\n    // MessageValuesもしくはpropertiesの中身をLogに出力\n    CheckObjectValues : function(obj){\n        for(key in obj)\n        {\n            // MESH SDK ではlogメソッドでMESHのLogに流すことが可能。デバッグができないので、基本的にこれで確認するしか無い？\n            log(\"key : \" + key + \" value : \" + obj[key]);\n        };\n    },\n\n    // Post IoT Hub のSuccess Call Back\n    SuccessFunc : function (data, textStatus, jqXHR ) {\n        log(\"Success Message \" + textStatus); \n        callbackSuccess( {\n            resultType : \"continue\",\n        });\n    },\n\n    // Post IoT Hub の Error Call Buck\n    ErrorFunc : function (request, errorMessage) {\n        log(\"Error jqxhr \" + request.message);\n        log(\"Error text status \" + errorMessage);\n        callbackSuccess( {\n            resultType : \"continue\",\n        });\n    }\n}\n\n// Utilityクラス\nMorningGirl.Util = {\n    // Objectの型判定用メソッド\n    is : function(type,obj){\n        var clas = Object.prototype.toString.call(obj).slice(8, -1);\n        return obj !== undefined && obj !== null && clas === type;\n    },\n\n    TypeName : {\n        String : \"String\",\n        Number : \"Number\",\n        Boolean : \"Boolean\",\n        Date : \"Date\",\n        Error : \"Error\",\n        Array : \"Array\",\n        Function : \"Function\",\n        RegExp : \"RegExp\",\n        Object : \"Object\"\n    }\n}\ntry{\n    log(\"Start Azure IoT Connection\");\n    var IoTHub = new MorningGirl.AzureIot();\n\n    log(\"MorningGirl.AzureIot コンストラクタ完了\");\n    var rtnObj = IoTHub.SendIotHub();\n\n    log(\"End Azure IoT Connection\");\n}\ncatch(e)\n{\n    log(\"Error が発生しました。Message : \" + e);\n    return { resultType : \"continue\" }\n}\n\n// ajaxの非同期完了もしくはタイムアウトまで待機するため、返り値にpauseを指定\nreturn { resultType : \"pause\" }","result":""}}]}}